(function(){$.fn.extend({omAjaxErrorHandler:function(h,j,i,e){var f={type:"error",title:"操作出错",timeout:3000};$.extend(f,e);var g=h.responseText;g=(!g)?i:g;f.content=(!f.content)?g:f.content.replace("{error}",g);$.omMessageTip.show(f)}});var b=$.ui;if(b){if(b.sortable){$.widget.bridge("sortable",b.sortable)}}$.omWidget("om.fixOmCombo",$.om.omCombo,{_valueKey:"_value",superclass:$.om.omCombo.prototype,_bindEvent:function(){var i=this,h=this._valueKey;options=this.options,emptyText=options.emptyText,input=this.element,span=input.parent("span");this.superclass._bindEvent.call(this);var f=input.next(":hidden");if(!f.length){var e=input.attr("name");f=$('<input type="hidden" />').attr("name",e);input.attr("name",null).after(f)}function g(){f.val(i.value())}input.blur(function(j){g()})}});$.extend($.om.omMenu.prototype,{_bindEvent:function(){var n=this,h=n.element,o=n.options,l=h.find("ul"),m=h.find("li"),g=$(document),e;for(var k=0;k<m.length;k++){if(!$(m[k]).hasClass("om-state-disabled")){n._bindLiEvent(m[k])}}for(var f=0;f<l.length;f++){$(l[f]).bind("mouseleave.menuContainer",function(){var i=$(this);if(i.parent().attr("aria-haspopup")=="true"){i.hide()}})}this.globalEvent=[];g.bind("mousedown.omMenu",e=function(){n._hide()});this.globalEvent.push(e);g.bind("keyup.omMenu",e=function(j){if(!h.is(":visible")){return true}var i=j.keyCode,p=$.om.keyCode;switch(i){case p.DOWN:n._selectNext();break;case p.UP:n._selectPrev();break;case p.LEFT:n._hideRight();break;case p.RIGHT:n._showRight();break;case p.ENTER:if(h.css("display")=="block"){n._backfill(h)}break;case p.ESCAPE:n._hide();break;default:null}});this.globalEvent.push(e);g.bind("keydown.omMenu",e=function(i){if(!h.is(":visible")){return true}if(i.keyCode>=37&&i.keyCode<=40){i.preventDefault()}});this.globalEvent.push(e)}});function a(f,e){if(e.content){$(f).html(e.content)}return $(f).omPanel(e)}function c(){return $.browser.msie&&parseInt($.browser.version)==7}$.extend($.om.omTabs.prototype,{_reload:function(h,g,i){var j=this.element,e=this.items,f=this._getAlter(h);if(g){this._removeLoadInfo(f);e[h].omPanel("reload",g)}else{if(i){e[h].html(i)}else{e[h].omPanel("reload");this._removeLoadInfo(f)}}},_getTabUrl:function(f){var h=this.element,e=h.items;if(typeof f!="number"){f=this._getAlter(f)}var g=e[f];if(g){return g.omPanel("option","url")}return null},_add:function(g){var l=this,n=this.element,p=this.options,k=this.items;var h=n.find(">div.om-tabs-headers ul");var f=g.tabId?g.tabId:tabIdPrefix+id++;g.index=g.index||"last";if(g.index=="last"||g.index>k.length-1){g.index=k.length}g.title=g.title||"New Title "+f;g.url=$.trim(g.url);g.content=$.trim(g.content);if(g.url){g.content=undefined}else{g.url=undefined;g.content=g.content||"New Content "+f}if(p.onBeforeAdd&&l._trigger("onBeforeAdd",null,g)==false){return false}var m=$('<li class="om-state-default om-corner-top"> </li>');var o=$('<a class="om-tabs-inner"></a>').html(g.title).attr({href:"#"+f,tabId:f}).css({width:p.tabWidth,height:p.tabHeight}).appendTo(m);$('<span class="lileft"></span>').insertBefore(o);if(c()){o.attr("hideFocus","true")}if((g.closable===true)||(g.closable==undefined&&p.closable)){o.after('<a class="om-icon om-icon-close"></a>');$('<span class="liright"></span>').insertAfter(o.next(".om-icon-close"))}else{$('<span class="liright"></span>').insertAfter(o)}var i={tabId:f,title:o.text(),_closeMode:"visibility",header:false,closed:true,onSuccess:function(q,s,r){l._trigger("onLoadComplete",null,f)},onError:function(r,s,q){l._trigger("onLoadComplete",null,f)}};$.extend(i,g);if(g.url&&(p.lazyLoad||g.lazyLoad)){l.loadInfo.push({tabId:f,url:g.url,loaded:false});i.url=null}var e=new a($("<div>"+(g.content||"")+"</div>")[0],i);if(g.index==k.length){k[g.index]=e;m.insertBefore(h.find("span.right-placeholder"))}else{k.splice(g.index,0,e);h.children().eq(g.index).before(m)}if(h.innerWidth()-m.position().left<500){h.width(h.width()+500)}this._checkScroller()&&this._enableScroller();var j=k[g.index].addClass("om-state-nobd").parent();$panels=n.find(">div.om-tabs-panels");if(k.length==1){j.appendTo($panels)}else{j.insertAfter(g.index>0?$panels.children().eq(g.index-1):0)}this._purgeEvent();this._buildEvent();this._trigger("onAdd",null,i);if(!(g.activateNew===false)){this._activate(g.index)}}});$.omWidget("om.fixOmBorderLayout",$.om.omBorderLayout,{_resizeRegion:function(){$.om.omBorderLayout.prototype._resizeRegion.call(this);this._updateLayout()},_updateLayout:function(){var e=this._getRegion("north");$southRegion=this._getRegion("south"),$westRegion=this._getRegion("west"),$eastRegion=this._getRegion("east"),$northProxy=this._getRegionProxy("north"),$southProxy=this._getRegionProxy("south"),$westProxy=this._getRegionProxy("west"),$eastProxy=this._getRegionProxy("east");if(e){e.css({width:"100%"});e.find(">.om-panel-header").css({width:"100%"});e.find(">.om-panel-body").css({width:"100%"})}if($northProxy){$northProxy.css({width:"100%"})}if($southRegion){$southRegion.css({width:"100%"});$southRegion.find(">.om-panel-header").css({width:"100%"});$southRegion.find(">.om-panel-body").css({width:"100%"})}if($southRegion){$southRegion.css({width:"100%"})}$("#debug").text(e.html()+" -- "+$northProxy.html())},_buildRegion:function(){$.om.omBorderLayout.prototype._buildRegion.call(this);var e=this;var f=this.element;this.element.addClass("om-borderlayout");f.css("padding","0");if(this.options.fit){f.css({width:"100%",height:"100%"});$(window).unbind("resize.fixOmBorderLayout").bind("resize.fixOmBorderLayout",function(h,g){e._resizeRegion()})}}});$.omWidget("om.fixOmTree",$.om.omTree,{options:{checkboxKey:"id",checkboxName:"checkedIds",checkboxTempl:'<input type="checkbox" name="{name}" value="{value}" style="display:none;" />',},check:function(e){this._toggleCheck($("#"+e.nid),false)},initChecks:function(e){if(!e||!e.length){return}for(var g=0;g<e.length;g++){var h=e[g];var f=h.children;if(f&&(f.length)>0){for(var g=0;g<f.length;g++){var j=f[g];this._toggleCheck($("#"+j.nid),checked)}return false}}},_setData:function(e){alert(e)},_toggleCheckbox:function(h,g){var j=this.options;var i=h.parent(".om-tree-node");var f=this.findByNId(i.attr("id"));var e=h.children(":checkbox");if(!e.length){e=$(j.checkboxTempl.replace("{name}",j.checkboxName).replace("{value}",f[j.checkboxKey]));h.append(e)}e.attr("checked",!g)},_toggleCheck:function(j,h){var i=j.find(">div.tree-checkbox"),e=this,f=e.options,g=f.onCheck;if(h){i.removeClass("checkbox_part checkbox_full")}else{i.removeClass("checkbox_part").addClass("checkbox_full")}if(f.showCheckbox){e._toggleCheckbox(i,h)}if(e.options.cascadeCheck){e._setChildCheckbox(j,!h);e._setParentCheckbox(j)}g&&e._trigger("onCheck",null,e.findByNId(j.attr("id")))},_setParentCheckbox:function(h){var k=this._getParentNode(h);if(k){var j=k.find(">ul >li >div.tree-checkbox");var e=j.length;var l=j.filter(".checkbox_full").length;var f=j.filter(".checkbox_part").length;var i=k.find(">div.tree-checkbox");i.removeClass("checkbox_full checkbox_part");var g=true;if(l==e){i.addClass("checkbox_full")}else{if(l>0||f>0){i.addClass("checkbox_part")}else{g=false}}if(this.options.showCheckbox){this._toggleCheckbox(i,!g)}this._setParentCheckbox(k)}},_setChildCheckbox:function(f,e){var h=f.find(">ul").find(".tree-checkbox");var g=this;if(g.options.showCheckbox){h.each(function(i){g._toggleCheckbox($(this),!e)})}h.removeClass("checkbox_part checkbox_full");if(e){h.addClass("checkbox_full")}},checkAll:function(e){if(e){this.element.find(".tree-checkbox").removeClass("checkbox_part").addClass("checkbox_full")}else{this.element.find(".tree-checkbox").removeClass("checkbox_part checkbox_full")}},findNodesBy:function(l,k,g){var j,m=k?k.children:this.getData();g=(g!=false)?true:g;var f=[];var e=-1;if(m&&(e=m.length)>0){for(var h=0;h<e;h++){if(l.call(m[h],m[h])===true){f.push(m[h])}if(g&&m[h].children){j=this.findNodesBy(l,m[h],g);if(j){f=f.concat(j)}}}}return f.length>0?f:null}});function d(e){return/\d+%$/.test(e)}$.omWidget("om.fixOmGrid",$.om.omGrid,{options:{jsonExt:".json",dataForm:undefined,startParam:"start",limitParam:"limit",pageNoParam:"nowPage",infoMsgCls:"message",errorMsgCls:"errorMessage",messageDelay:2000,onError:$.fn.omAjaxErrorHandler,idProp:"id",batchSaveUrl:undefined,batchDeleteUrl:undefined},_measure:function(f,h){var g=h.width,e=h.height;if(d(g)){f.css("width",g)}else{f.outerWidth(h.width==="fit"?f.parent().width():h.width)}if(d(e)){f.css("height",e)}else{f.outerHeight(h.height==="fit"?f.parent().height():h.height)}},_loadAjaxSettings:function(g,m,f,h){var n=this;var j=g.nowPage||1;var l=(m.limit<=0)?100000000:m.limit;var e=l*(j-1);var i={_time_stamp_:new Date().getTime()};i[m.startParam]=e;i[m.limitParam]=l;i[m.pageNoParam]=j;i=$.extend(true,m.extraData,i);var k={type:m.method,url:m.dataSource,data:i,dataType:"json",success:function(r,t,q){var s=m.onSuccess;if(typeof(s)=="function"){n._trigger("onSuccess",null,r,t,q)}n._addData(r);n._trigger("onRefresh",null,j,r.rows);for(var p=0,o=m._onRefreshCallbacks.length;p<o;p++){m._onRefreshCallbacks[p].call(n)}f.hide();n._bindGridEvents();n.loading=false},error:function(p,s,r){h.html($.om.lang._get(m,"omGrid","errorMsg")).css("color","red");try{var o=m.onError;if(typeof(o)=="function"){o(p,s,r)}}catch(q){}finally{f.hide();n.loading=false;return false}}};return k},_bindGridEvents:function(){var g=this,e=this.element;var f=$.omUI.omCrudGrid;e.find(".editLabel").click(function(){var i=$(this).attr("optId");if(!i){alert("optId invalid!"+i);return false}var h=f._getOptRow(this);g.editOpt(i,h[0]);return false});e.find(".deleteLabel").click(function(){var i=$(this).attr("optId");if(!i){alert("optId invalid!"+i);return false}var h=f._getOptRow(this);g.deleteOpt(i,h[0]);return false});e.find(".ajaxOptLabel").click(function(){var i=this.href||this.value;if(!i){alert("optURL invalid!"+i);return false}var h=f._getOptRow(this);g.doAjaxOpt(h[0],{url:i});return false});e.find(".editOptLabel").click(function(){var h=f._getOptRow(this);var i=this.href||this.value;if(!i||i=="#"||i.indexOf("javascript:")==0){return false}g.editByUrl(i,h[0]);return false})},_loadDataByForm:function(e,f){var h=this.options;if(!f.url){var g=e.attr("action");g=g.replace(/(\.[^.]*$)/g,"")+h.jsonExt;f.url=g}f.type=e.attr("method");e.ajaxSubmit(f);return false},_initDataForm:function(e,f){var g=this;e.children().find(":submit").click(function(){f.nowPage=1});e.submit(function(h){g._populate();return false})},_populate:function(){var m=this,i=this.element,e=i.closest(".om-grid"),l=this.options,h=$(".pPageStat",e);var j=l.beforeLoad;if(!l.dataForm&&!l.dataSource){$(".pPageStat",e).html(l.emptygMsg);return false}if(this.loading){return true}var g=this.pageData,k=undefined;if(l.dataForm){k=$(l.dataForm);if(m._formInited!=true){m._initDataForm(k,g);m._formInited=true}this.dataForm=k.get(0)}if(j){var o=j(this);if(o==false){return false}}var f=$(".gBlock",e);this.loading=true;h.html($.om.lang._get(l,"omGrid","loadingMsg"));f.show();if($.browser.opera){$(e).css("visibility","hidden")}var n=m._loadAjaxSettings(g,l,f,h);if(k){m._loadDataByForm(k,n)}else{$.ajax(n)}},batchSaveUpdate:function(){var i=this,k=this.options,g=k.batchSaveUrl,h="update";if(!g){alert("error:batchSaveUrl not config!");return false}var f=this._buildBatchPostData(h);if(f.length<1){alert("warning:there is no update data!");return false}var e={records:$.toJSON(f)};var j={url:g,data:e};this._postBatchOpt(j,h)},batchSaveDelete:function(){var i=this,k=this.options,e=k.batchDeleteUrl,h="delete";if(!e){alert("error:batchDeleteUrl not config!");return false}var g=this._buildBatchPostData(h);if(g.length<1){alert("warning:there is no delete data!");return false}var f={records:$.toJSON(updateData)};var j={url:batchSaveUrl,data:f};this._postBatchOpt(j,h)},_postBatchOpt:function(l,g){var i=this,k=this.options;var f=k.infoMsgCls,j=k.errorMsgCls,h=k.messageDelay;var e={success:function(p,q,o){if(p.indexOf("success:")==0){var m=('<b class="_MSGCLS_">操作成功</b>').replace("_MSGCLS_",f);$.omMessageTip.show({title:"操作成功",content:m,timeout:h});i.saveChanges()}else{var n=('<b>删除数据失败!</b><br/><b class="_MSGCLS_">'+p+"</b>").replace("_MSGCLS_",j);$.omMessageTip.show({type:"error",title:"操作失败",content:n,timeout:h})}},error:function(n,p,o){var m=('<b>删除数据出错!:</b><br/><b class="_MSGCLS_">{error}</b>').replace("_MSGCLS_",j);$.fn.omAjaxErrorHandler(n,p,o,{content:m,timeout:h})}};$.extend(e,l);$.ajax(e);return false},_buildBatchPostData:function(h){changeData=this._changeData,idProp=this.options.idProp;var g=changeData[h];var e=[];for(var f in g){var k=f;var j=this._rowIdDataMap[k];if(!j){continue}var i=g[f];if(!i){continue}if(idProp){k=j[idProp];if(!k){alert("error:no "+idProp+" value!"+k);return false}}i[idProp]=k;e.push(i)}return e}});$.extend($.om.fixOmGrid,{setDefaultOptions:function(e){$.extend(this.prototype.options,e)}});$.omWidget("omUI.omCrudGrid",$.om.fixOmGrid,{options:{editPanel:undefined,editShowMode:"dialog",editUrl:undefined,editMethod:"get",editParams:undefined,editReload:true,deleteUrl:undefined,deleteMethod:"delete",deleteParams:undefined,deleteConfirmMsg:"确定要删除数据吗?",deleteReload:true,reloadDelay:1000},bindEditPanel:function(j){var n=this,i=this.options;var f=i.editPanel;if(!f){alert("error:editPanel not config!"+f);return false}var o=$(f);var m=n._inputDialog;var k=i.messageDelay,e=i.reloadDelay,g=i.infoMsgCls,l=i.editShowMode,h=i.errorMsgCls;var p={width:"auto",height:"auto"};$.extend(p,j);o.bind($.omUI.omCrudGrid.defaults.LoadedSuccess,function(s,t,v,r){if(t.indexOf&&t.indexOf("error:")==0){var q=('数据获取失败!<br/><b class="_MSGCLS_">'+t+"</b>").replace("_MSGCLS_",h);$.omMessageTip.show({type:"error",title:"操作失败",content:q,timeout:k})}else{if(l=="dialog"){var u=n._inputDialog||n._initEditPanel(j);u.omDialog("option",p);u.omDialog("open")}else{o.find("#close-button").click(function(){o.empty()});o.show("blin")}}}).bind($.omUI.omCrudGrid.defaults.SaveDataSuccess,function(u,t,v,x,s){if(!v.indexOf){$.omMessageTip.show({title:"操作成功",content:v,timeout:3000});return false}else{if(v.indexOf("success:")==0){var q=('<b class="_MSGCLS_">修改数据成功</b>').replace("_MSGCLS_",g);$.omMessageTip.show({title:"操作成功",content:q,timeout:k});if(l=="dialog"){var w=n._inputDialog&&n._inputDialog.omDialog("close")}else{o.empty()}if(i.editReload==true){setTimeout(function(){n.reload()},e)}}else{var r=('<b>修改数据失败!</b><br/><b class="_MSGCLS_">'+v+"</b>").replace("_MSGCLS_",h);$.omMessageTip.show({type:"error",title:"操作失败",content:r,timeout:k})}}return false}).bind($.omUI.omCrudGrid.defaults.SaveDataError,function(s,r,q,u,t){errorMsg=('<b>编辑数据出错!:</b><br/><b class="_MSGCLS_">{error}</b>').replace("_MSGCLS_",h);$.fn.omAjaxErrorHandler(q,u,t,{content:errorMsg,timeout:k});return false})},_initEditPanel:function(o){var n=this,j=this.options;var k=j.messageDelay,e=j.reloadDelay,h=j.infoMsgCls,i=j.errorMsgCls,f=j.editPanel;var m=$(f);var g={width:"auto",modal:true,autoOpen:false,title:this.title,show:"blin",hide:"blin",onOpen:function(p,q){if(window._onGridEditDlgOpen){_onGridEditDlgOpen(this);delete window._onGridEditDlgOpen}},onClose:function(p){this.empty()}};$.extend(g,o);var l=m.omDialog(g);this._inputDialog=l;return l},editByUrl:function(i,m){var n=this.options;var h=n.editPanel;if(!h){alert("error:editPanel not config!");return false}var r=$(h);var k=n.deleteParams;var f=n.deleteReload;var e=n.editMethod;var t=this._optForm;if(!t){t=$('<form method="get"></form>');t=$(t);this._optForm=t}var o=n.messageDelay,p=n.editShowMode,g=n.reloadDelay,j=n.infoMsgCls,l=n.errorMsgCls;if(p=="dialog"){var q=this._inputDialog;if(!q){q=this._initEditPanel()}}var s=$(m);s.fadeOut();t.ajaxSubmit({url:i,type:e,target:h,success:function(v,w,u){r.trigger($.omUI.omCrudGrid.defaults.LoadedSuccess,[v,w,u])},error:function(v,x,w){var u=('<b>编辑数据出错!:</b><br/><b class="_MSGCLS_">{error}</b>').replace("_MSGCLS_",l);$.fn.omAjaxErrorHandler(v,x,w,{content:u,timeout:o})},complete:function(){s.fadeIn()}});return false},editOpt:function(i,e){i=i||"";var g=this,h=this.options;var f=h.editUrl;if(!f){alert("error:editUrl not config!");return false}f=f.replace("{id}",i);this.editByUrl(f,e);return false},doAjaxOpt:function(g,e){var h=this,f=$(g),i=this.options;f.fadeOut();e=$.extend({url:undefined,type:undefined,data:undefined,ajaxSuccess:function(k,l,j){$.omMessageTip.show({title:"操作成功",content:k,timeout:3000});h.reload()},ajaxFailed:function(k,l,j){$.omMessageTip.show({title:"操作失败",content:k,timeout:3000})},ajaxError:function(j,l,k){$.omMessageTip.show({title:"操作出错",content:j.responseText,timeout:3000})},success:function(k,l,j){if(!k.indexOf||k.indexOf("success:")==0){e.ajaxSuccess(k,l,j)}else{f.fadeIn();e.ajaxFailed(k,l,j)}},error:function(j,l,k){f.fadeIn();e.ajaxError(j,l,k)}},e);$.ajax(e);return false},deleteOpt:function(h,n){var q=this,o=this.options;var i=o.deleteUrl;if(!i){alert("error:deleteUrl not config!");return false}if(o.deleteConfirmMsg){var m=confirm(o.deleteConfirmMsg);if(m!=true){return false}}i=i.replace("{id}",h);var k=o.deleteParams,f=o.deleteReload,e=o.deleteMethod,p=o.messageDelay,g=o.reloadDelay,j=o.infoMsgCls,l=o.errorMsgCls;return this.doAjaxOpt(n,{url:i,type:e,data:k,ajaxSuccess:function(t,u,s){var r=('<b class="_MSGCLS_">删除数据成功</b>').replace("_MSGCLS_",j);$.omMessageTip.show({title:"操作成功",content:r,timeout:p});if(f==true){setTimeout(function(){q.reload()},g)}},ajaxFailed:function(t,u,s){var r=('<b>删除数据失败!</b><br/><b class="_MSGCLS_">'+t+"</b>").replace("_MSGCLS_",l);$.omMessageTip.show({type:"error",title:"操作失败",content:r,timeout:p})},ajaxError:function(s,u,t){var r=('<b>删除数据出错!:</b><br/><b class="_MSGCLS_">{error}</b>').replace("_MSGCLS_",l);$.fn.omAjaxErrorHandler(s,u,t,{content:r,timeout:p})}})}});$.extend($.omUI.omCrudGrid,$.om.fixOmGrid,{defaults:{dateFormat:"yy-mm-ddTH:i:s",LoadedSuccess:"editForm.loaded.success",SaveDataSuccess:"editForm.saveData.success",SaveDataError:"editForm.saveData.error"},setDefaults:function(e){$.extend($.omUI.omCrudGrid,e)},_getUI:function(e){if(!e){return undefined}return $.data(e,this.prototype.widgetName)},prepareEditForm:function(e,m){if(!e){return}var i=this.defaults;var j=$(e);var g=j.parent();var k=i.SaveDataSuccess;var f=i.SaveDataError;var l=$.extend(m.ajax,{success:function(o,p,n){g.trigger(k,[j[0],o,p,n])},error:function(n,p,o){g.trigger(f,[j[0],n,p,o])},complete:function(){j.fadeIn()}});var h=$.extend(m.validations,{submitHandler:function(){j.fadeOut();j.ajaxSubmit(l);return false}});j.validate(h)},handleSaveDataSuccess:function(){},renderDateCol:function(e,g){g=(!g)?$.omUI.omCrudGrid.defaults.dateFormat:g;var f=$.omCalendar.parseDate(e,g);if(!f||isNaN(f)){return e}return f.toLocaleString()},renderEmailCol:function(e){return'<b class="emailLabel"><a href="mailto:'+e+'">'+e+"</a>"},_getOptRow:function(e){return $(e).closest(".om-grid-row")},renderOptCol:function(f,q){var h={canDel:true,canEdit:true,advOpt:undefined};$.extend(h,q);var n=this;var p=undefined;var j=undefined;var m=$("<span></span>");if(h.canEdit){p=$('<b><a class="editLabel" optId="_ID_" href="#">修改</a></b>'.replace("_ID_",f));m=m.append(p)}if(h.canDel){j=$('<b><a class="deleteLabel" optId="_ID_" href="#">删除</a></b>'.replace("_ID_",f));m=m.append(j)}var k=h.advOpts;if(k){for(var o in k){var e=k[o];var l=e.templ;if(!l){continue}var i=e.optClass||"editOptLabel";var g=$(l.replace("_ID_",f));g.addClass(i);m=m.append(g)}}return m.html()}})})(jQuery);